const readline = require('readline');
const Calculadora = require('./calculadora');

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

const calc = new Calculadora();

function mostrarMenu() {
  console.log('\n=================================');
  console.log('     CALCULADORA INTERACTIVA     ');
  console.log('=================================');
  console.log('1. Sumar');
  console.log('2. Restar');
  console.log('3. Multiplicar');
  console.log('4. Dividir');
  console.log('5. Potencia');
  console.log('6. Ra√≠z Cuadrada');
  console.log('7. Factorial');
  console.log('8. Resto')
  console.log('9.  Array Promedio');

  console.log('11. Guardar en memoria');
  console.log('12. Usar memoria');
  console.log('13. Limpiar memoria');
  console.log('0. Salir');
  console.log('=================================');
}

function pedirNumero(mensaje) {
  return new Promise((resolve) => {
    rl.question(mensaje, (respuesta) => {
      const numero = parseFloat(respuesta);
      resolve(numero);
    });
  });
}

async function pedirNumeroConMemoria(mensaje) {
  const memoriaActual = calc.obtenerDeMemoria();

  if (memoriaActual !== null) {
    const usarMemoria = await new Promise((resolve) => {
      rl.question(`¬øUsar valor de memoria (${memoriaActual})? (s/n): `, (respuesta) => {
        resolve(respuesta.toLowerCase() === 's');
      });
    });

    if (usarMemoria) {
      return memoriaActual;
    }
  }

  return await pedirNumero(mensaje);
}

async function operacionArrayNumeros(operacion, nombreOperacion) {
  let numeros = [];
  console.log(`\n-- Ingrese n√∫meros para calcular el ${nombreOperacion}. Escriba 'fin' para terminar. --`);

  while (true) {
    const respuesta = await new Promise((resolve) => {
      rl.question(`Ingrese n√∫mero ${numeros.length + 1} (o 'fin'): `, resolve);
    });

    if (respuesta.toLowerCase() === 'fin') {
      break;
    }

    const numero = parseFloat(respuesta);

    if (!isNaN(numero)) {
      numeros.push(numero);
    } else {
      console.log('‚ö†Ô∏è  Entrada inv√°lida. Intente de nuevo.');
    }
  }

  if (numeros.length === 0) {
    console.log(`\n‚ö†Ô∏è  No se ingresaron n√∫meros para calcular el ${nombreOperacion}.`);
    return;
  }

  const resultado = operacion(numeros);
  const numerosStr = `[${numeros.join(', ')}]`;

  if (resultado === undefined) {
    console.log(`\n‚ö†Ô∏è  La funci√≥n ${nombreOperacion} a√∫n no est√° implementada en Calculadora.js`);
  } else if (typeof resultado === 'string') {
    console.log(`\n‚ö†Ô∏è  Error: ${resultado}`);
  } else {
    console.log(`\n‚úì Resultado: ${nombreOperacion} de ${numerosStr} = ${resultado}`);
  }
}

async function operacionDosNumeros(operacion, nombreOperacion) {
  const num1 = await pedirNumeroConMemoria('Ingrese el primer n√∫mero: ');
  const num2 = await pedirNumeroConMemoria('Ingrese el segundo n√∫mero: ');

  const resultado = operacion(num1, num2);

  if (resultado === undefined) {
    console.log(`\n‚ö†Ô∏è  La funci√≥n ${nombreOperacion} a√∫n no est√° implementada`);
  } else if (typeof resultado === 'string' && resultado.includes('Error')) {
    console.log(`\n‚ùå ${resultado}`);
  } else {
    console.log(`\n‚úì Resultado: ${num1} ${getSimboloOperacion(nombreOperacion)} ${num2} = ${resultado}`);

    // Preguntar si guardar en memoria autom√°ticamente
    const guardar = await new Promise((resolve) => {
      rl.question('¬øGuardar resultado en memoria? (s/n): ', (respuesta) => {
        resolve(respuesta.toLowerCase() === 's');
      });
    });

    if (guardar) {
      calc.guardarEnMemoria(resultado);
      console.log('üíæ Resultado guardado en memoria');
    }
  }
}

async function operacionUnNumero(operacion, nombreOperacion) {
  const num = await pedirNumero('Ingrese el n√∫mero: ');
  
  const resultado = operacion(num);
  
  if (resultado === undefined) {
    console.log(`\n‚ö†Ô∏è  La funci√≥n ${nombreOperacion} a√∫n no est√° implementada`);
  } else if (isNaN(resultado)) {
    console.log(`\n‚ö†Ô∏è  Error: Operaci√≥n inv√°lida (resultado: NaN)`);
  } else if (typeof resultado === 'string') {
    console.log(`\n‚ö†Ô∏è  Error: ${resultado}`);
  } else {
    console.log(`\n‚úì Resultado: ‚àö${num} = ${resultado}`);
  }
}

function getSimboloOperacion(nombre) {
  const simbolos = {
    'suma': '+',
    'resta': '-',
    'multiplicaci√≥n': '√ó',
    'divisi√≥n': '√∑',
    'potencia': '^'
  };
  return simbolos[nombre] || '';
}

async function ejecutarOpcion(opcion) {
  switch(opcion) {
    case '1':
      await operacionDosNumeros(
        (a, b) => calc.sumar(a, b),
        'suma'
      );
      break;
    
    case '2':
      await operacionDosNumeros(
        (a, b) => calc.restar(a, b),
        'resta'
      );
      break;
    
    case '3':
      await operacionDosNumeros(
        (a, b) => calc.multiplicar(a, b),
        'multiplicaci√≥n'
      );
      break;
    
    case '4':
      await operacionDosNumeros(
        (a, b) => calc.dividir(a, b),
        'divisi√≥n'
      );
      break;
    
    case '5':
      const base = await pedirNumero('Ingrese la base: ');
      const exponente = await pedirNumero('Ingrese el exponente: ');
      const resultadoPot = calc.potencia(base, exponente);
      
      if (resultadoPot === undefined) {
        console.log('\n‚ö†Ô∏è  La funci√≥n potencia a√∫n no est√° implementada');
      } else {
        console.log(`\n‚úì Resultado: ${base}^${exponente} = ${resultadoPot}`);
      }
      break;
    
    case '6':
      await operacionUnNumero(
        (num) => calc.raizCuadrada(num),
        'ra√≠z cuadrada'
      );
      break;
    // declaracion de funcion factorial
    case '7':
      const numeroFact = await pedirNumero('Ingrese el n√∫mero para calcular su factorial: ');
      const resultadoFact = calc.factorial(numeroFact);
      
      if (resultadoFact === undefined) {
        console.log('\n La funci√≥n factorial a√∫n no est√° implementada');
      } else if (typeof resultadoFact === 'string') {
        console.log(`\n Error: ${resultadoFact}`);
      } else {
        console.log(`\n‚úì Resultado: ${numeroFact}! = ${resultadoFact}`);
      }
      break;

    //declaracion de funcion resto
    case '8':
    await operacionDosNumeros(
            (a, b) => calc.resto(a, b),
            'resto'
          );
          break;

      case '9':
        await operacionArrayNumeros(
          (arr) => calc.promedio(arr), //
          'Promedio de Array'
        );
        break;

    case '11':
    // Guardar en memoria
        const valor = await pedirNumero('Ingrese el valor a guardar en memoria: ');
        calc.guardarEnMemoria(valor);
        console.log(`üíæ Valor ${valor} guardado en memoria`);
        break;

    case '12':
    // Usar memoria
      const memoria = calc.obtenerDeMemoria();
      if (memoria === null) {
        console.log('\nüíæ No hay valor guardado en memoria');
      } else {
        console.log(`\nüíæ Valor en memoria: ${memoria}`);
      }
      break;

    case '13':
    // Limpiar memoria
       const mensaje = calc.limpiarMemoria();
       console.log(`\n${mensaje}`);
       break;

    case '0':
      console.log('\n¬°Hasta luego! üëã');
      rl.close();
      return false;
    
    default:
      console.log('\n‚ö†Ô∏è  Opci√≥n inv√°lida. Por favor intente nuevamente.');
  }
  
  return true;
}

async function iniciar() {
  let continuar = true;
  
  while (continuar) {
    mostrarMenu();
    
    const opcion = await new Promise((resolve) => {
      rl.question('\nSeleccione una opci√≥n: ', resolve);
    });
    
    continuar = await ejecutarOpcion(opcion);
  }
}

// Iniciar el cliente
console.log('Bienvenido a la Calculadora Interactiva');
iniciar();